<languages/>

{{Docnav/ru
|[[Manual:Creating and manipulating geometry/ru|Создание и манипуляция геометрией]]
|[[Manual:Creating interface tools/ru|Создание инструментов интерфейса]]
|[[Manual:Introduction/ru|Руководство: Начало]]
|IconC=Crystal Clear manual.png
}}

{{Manual:TOC}}

В [[Manual:Creating and manipulating geometry/ru|предыдущей главе]] мы рассмотрели, как создавать геометрию '''Детали - Part''' и отображать её на экране, прикрепляя её к объекту "болванке" (непараметрическому)  документа. Несмотря на свою эффективность, этот подход становится непрактичным, когда необходимо изменить форму. Каждое изменение требует создания новой формы и повторного назначения её объекту, что приводит к повторяющемуся и неэффективному рабочему процессу.

На протяжении всего этого руководства мы видели, как параметрические объекты решают эту проблему, позволяя динамически обновлять форму. При изменении одного свойства форма пересчитывается автоматически, что устраняет необходимость в ручном обновлении. Этот процесс пересчёта обеспечивает более эффективное моделирование и повышает адаптивность конструкций. Внутри параметрические объекты работают аналогично тому, что мы уже сделали: они пересчитывают содержимое своего свойства '''Shape - Форма''' каждый раз, когда одно из их свойств меняется. Этот итерационный процесс не вызывает затруднений и обеспечивает соответствие объекта заданным параметрам.

FreeCAD предлагает удобную систему для создания параметрических объектов полностью реализованную на языке Python. Эти объекты определяются с помощью класса Python, который:

* Объявляет необходимые свойства объекта.
* Определяет поведение при изменении любого из этих свойств.
Структура такого параметрического объекта выглядит следующим образом:

{{Code|code=
class myParametricObject:

    def __init__(self, obj):
        obj.Proxy = self
        obj.addProperty("App::PropertyFloat", "MyLength")
        ...

    def execute(self,obj):
        print ("Recalculating the shape...")
        print ("The value of MyLength is:")
        print (obj.MyLength)
        ...
}}

Все классы Python обычно имеют метод '''__init__'''. Этот метод выполняется при инициализации класса, то есть при создании объекта Python на основе класса. Класс можно рассматривать как "шаблон" или чертёж, используемый для создания реальных экземпляров самого себя. Каждый экземпляр класса становится независимым объектом со своими атрибутами и методами. В нашем методе '''__init__''' мы выполняем две важнейшие задачи:

* Храним сам класс в атрибуте '''Proxy''' объекта документа FreeCAD:
Присваивая '''self''' атрибуту '''Proxy''' объекта документа FreeCAD, мы связываем логику нашего класса Python с объектом FreeCAD. Это означает, что объект документа будет "содержать" код класса Python внутри себя, позволяя ему вести себя в соответствии с логикой, определённой в классе. Эта связь позволяет FreeCAD знать, как взаимодействовать с параметрическим объектом и пересчитывать его.

* Создаём все свойства, необходимые объекту:
Используя метод '''addProperty''', мы определяем пользовательские свойства, необходимые объекту. Свойства выступают в качестве параметров или переменных для объекта и могут быть доступны, изменены и отображены в редакторе свойств FreeCAD. В примере мы добавляем свойство с плавающей точкой под названием '''MyLength'''. Это свойство в дальнейшем будет влиять на форму или поведение объекта.

There are many types of properties available in FreeCAD, ranging from floating-point numbers to strings and even specialized types for geometry and materials. To explore the full list of available property types, you can type the following code in the Python console:

{{Code|code=
FreeCAD.ActiveDocument.addObject("Part::FeaturePython", "dummy").supportedProperties()
}}

<div class="mw-translate-fuzzy">
Все классы Python обычно имеют метод __init__. Всё, что внутри этого  метода, исполняется когда создаётся экземпляр этого класса (что знает, на программистском сленге, что объект Python создаётся из этого класса. Представляйте класс как "шаблон" для создания живых копий). В наших функциях __init__ мы здесь делаем две важные вещи: 1- сохраняем наш класс в атрибут "Proxy" объекта нашего документа FreeCAD, то есть документ FreeCAD будет носить этот код в себе, и 2- создает все параметры, которые нужны нашему объекту. Доступны множество типов параметров, Вы можете получить полный список, набрав следующий код:
</div>

In summary:

* The '''execute''' method is called whenever the object needs to be updated.
* It is responsible for recalculating the shape and assigning it to the object's '''Shape''' attribute.
* The '''obj''' argument gives access to the FreeCAD document object, enabling you to make changes programmatically.
With this system, FreeCAD handles the rest—ensuring that the object is properly updated in the document and displayed correctly in the graphical interface.

<div class="mw-translate-fuzzy">
Следующая важная часть это исполняемый метод. Любой код в этом методе исполняется когда объект маркирован для пересчёта, что происходит когда объект изменяется. Это всё, что есть. Внутри исполнения требуется сделать всё, что надо, то есть вычисление новой формы, и приписывания объекту чего-то вроде obj.Shape = myNewShape. Вот почему исполняемый метод принимает аргумент "obj", которых будет самим документом FreeCAD, так что мы можем манипулировать им внутри нашего кода python.
</div>

<div class="mw-translate-fuzzy">
Последняя вещь, которую важно запомнить: когда Вы создаёте такой параметрический объект в документе FreeCAD, когда Вы сохраняете файл, вышеуказанный код python не сохраняется в файле. Это происходит из соображений безопасности, если бы файлы FreeCAD содержали код, у злоумышленников была бы возможность распространять файлы FreeCAD с вредоносным кодом, который мог бы повреждать чужие компьютеры. Так что если Вы распространяете файл, который содержит объекты, сделанные с помощью вышеуказанного года, этот код должен так же находиться на компьютерах, которые откроют файл. Простейший путь достичь этого - сохранить код в макросе, и распространять макрос вместе с файлом, или делиться своим макросом на [[Macros_recipes/ru|репозитории макросов FreeCAD]], где каждый сможет загрузить его.
</div>

Ниже мы выполним маленькое упражнение, создав параметрический объект - простейшая параметрическая прямоугольная грань. Более сложные примеры доступны в [[Scripted_objects/ru|примере параметрического объекта]] и в [https://github.com/FreeCAD/FreeCAD/blob/master/src/Mod/TemplatePyMod/FeaturePython.py коде самого FreeCAD].

<div class="mw-translate-fuzzy">
Мы придадим нашему объекту два параметра: Length и Width, которые мы будем использовать для создания прямоугольника. Затем, поскольку наш объект уже имеет встроенный параметр Placement (все геометрические объекты имеют его по умолчанию, их не надо добавлять самостоятельно), мы поместим наш прямоугольник в положение/наклон, установленные в Placement, так что пользователь сможет перемещать прямоугольник редактированием параметра Placement.
</div>

{{Code|code=
class ParametricRectangle:

    def __init__(self,obj):
        obj.Proxy = self
        obj.addProperty("App::PropertyFloat", "Length")
        obj.addProperty("App::PropertyFloat", "Width")

    def execute(self, obj):
        # We need to import the FreeCAD module here too, because we might be running out of the Console
        # (in a macro, for example) where the FreeCAD module has not been imported automatically:
        import FreeCAD
        import Part

        # First we need to make sure the values of Length and Width are not 0
        # otherwise Part.LineSegment will complain that both points are equal:
        if (obj.Length == 0) or (obj.Width == 0):
            # If yes, exit this method without doing anything:
            return

        # We create 4 points for the 4 corners:
        v1 = FreeCAD.Vector(0, 0, 0)
        v2 = FreeCAD.Vector(obj.Length, 0, 0)
        v3 = FreeCAD.Vector(obj.Length,obj.Width, 0)
        v4 = FreeCAD.Vector(0, obj.Width, 0)

        # We create 4 edges:
        e1 = Part.LineSegment(v1, v2).toShape()
        e2 = Part.LineSegment(v2, v3).toShape()
        e3 = Part.LineSegment(v3, v4).toShape()
        e4 = Part.LineSegment(v4, v1).toShape()

        # We create a wire:
        w = Part.Wire([e1, e2, e3, e4])

        # We create a face:
        f = Part.Face(w)

        # All shapes have a Placement too. We give our shape the value of the placement
        # set by the user. This will move/rotate the face automatically.
        f.Placement = obj.Placement

        # All done, we can attribute our shape to the object!
        obj.Shape = f
}}

<div class="mw-translate-fuzzy">
Вместо того чтобы вставить вышеуказанный код в консоль Python, лучше сохраним его где-нибудь, чтобы мы могли повторно использовать и модифицировать его позднее. Например, в макросе (меню Tools -> Macros -> Create). Назовём его, например, "ParamRectangle". Тем не менее, макрос FreeCAD сохраняется с расширением .FCMacro, который Python не разспознаёт при импорте. Поэтому перед использованием этого кода нам надо переименовать ParamRectangle.FCMacro в ParamRectangle.py. Это легко делается в вашем менеджере файлов, найдя папку Macros, показанную в меню Tools -> Macros.
</div>

Когда это сделано, мы можем сделать это в консоли Python:

{{Code|code=
import ParamRectangle
}}

Открывая содержимое ParamRectangle, мы убедимся, что он содержит лишь наш класс ParametricRectangle.

<div class="mw-translate-fuzzy">
Для создания нового параметрического объекта с использованием нашего класса ParametricRectangle мы будем использовать следующий код. Заметьте, что мы используем Part::FeaturePython вместо Part::Feature, который мы использовали в предыдущих главах (версия Python позволяет определить наш собственное параметрическое поведение):
</div>

{{Code|code=
myObj = FreeCAD.ActiveDocument.addObject("Part::FeaturePython", "Rectangle")
ParamRectangle.ParametricRectangle(myObj)
myObj.ViewObject.Proxy = 0 # This is mandatory unless we code the ViewProvider too.
FreeCAD.ActiveDocument.recompute()
}}

Here is a quick breakdown of the previous commands:

* '''myObj = FreeCAD.ActiveDocument.addObject("Part::FeaturePython", "Rectangle")''': Creates a new '''Part::FeaturePython''' object named '''Rectangle''' in the active FreeCAD document. This object is specifically designed for custom parametric behavior, allowing Python-defined logic to manage its properties and behavior.

* '''ParamRectangle.ParametricRectangle(myObj)''': Initializes the object by associating it with the '''ParametricRectangle''' class from the '''ParamRectangle''' module or script. This links the custom Python-defined logic to the object, enabling it to act as a parametric object.

* '''myObj.ViewObject.Proxy = 0''': Resets the '''ViewObject.Proxy''' attribute to 0, ensuring that the object uses FreeCAD’s default view handling. This step is required unless you define a custom ViewProvider to manage the visual representation of the object.

* '''FreeCAD.ActiveDocument.recompute()''': Recomputes the document to update the geometry and reflect changes in the FreeCAD graphical interface, making the new object fully visible and functional

<div class="mw-translate-fuzzy">
Пока ничего на экране не появилось, поскольку параметры Length и Width равны 0, что включает наше правило "do-nothing" внутри execute. Нам надо просто изменить значения Length и Width, и наш объект волшебно появится и будет пересчитан на лету.
</div>

<div class="mw-translate-fuzzy">
Разумеется, было бы утомительно вводить эти 4 строки кода Python каждый раз, когда нам нужно создать новый параметрический прямоугольник. Простой путь решить это - поместить эти 4 строки в наш файл ParamRectangle.py в конце, после класса ParametricRectange (Мы можем делать это в редакторе макросов).
</div>

<div class="mw-translate-fuzzy">
Теперь, когда мы напишем  import ParamRectangle , новый параметрический прямоугольник создастся автоматически. Даже лучше, мы можем добавить кнопку панели инструментов, которая сделает это:
</div>

<div class="mw-translate-fuzzy">
* Открыть меню '''Tools -> Customize'''
* На вкладке "Macros" выберите наш ParamRectangle.py, заполните детали по желанию и нажмите "Add":
 
[[Image:Exercise_python_04.jpg]]
</div>

[[File:FreeCAD_python_macroRec.png]]

* На вкладке Toolbars создайте новую панель инструментов в каком хотите верстаке (или глобально), выделите ваш макрос и добавьте его в панель инструментов:

[[File:FreeCAD_python_toolbarCus.png]]

* Это всё, мы уже имеем новую кнопку панели инструментов, которая при клике создаст параметрический прямоугольник.

<div class="mw-translate-fuzzy">
Запомните, если Вы хотите распространять файлы, созданные с помощью этого нового инструмента среди других людей, они должны так же иметь установленный на своём компьютере макрос ParamRectangle.py.
</div>

'''Читать далее'''

* [[Macros_recipes/ru|Репозиторий макросов FreeCAD]]
* [[Scripted_objects/ru|Пример параметрического объекта]]
* [https://github.com/FreeCAD/FreeCAD/blob/master/src/Mod/TemplatePyMod/FeaturePython.py Дополнительные примеры в коде FreeCAD]


{{Docnav/ru
|[[Manual:Creating and manipulating geometry/ru|Создание и манипуляция геометрией]]
|[[Manual:Creating interface tools/ru|Создание инструментов интерфейса]]
|[[Manual:Introduction/ru|Руководство: Начало]]
|IconC=Crystal Clear manual.png
}}

{{Powerdocnavi{{#translation:}}}}
[[Category:Developer Documentation{{#translation:}}]]
[[Category:Python Code{{#translation:}}]]